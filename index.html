<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GAME AFTER LUNCH | Leaderboard</title>
    <link rel="icon" type="image/png" href="assets/img/logo_gold.png" />
    <link
      href="../../bootstrap-5.3.8-dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="css/leaderboard.css" />
  </head>

  <body>
    <div class="main-card" id="dashboard-card">
      <img src="assets/img/logo_gold.png" alt="Logo" class="logo" />
      <h1>Leaderboard</h1>

      <div class="search-row">
        <input type="text" id="searchInput" placeholder="Search Name" />
        <button onclick="filterData()">Search</button>
        <button onclick="adminPage()">Admin</button>
        <button onclick="goToBadgeGallery()">Badge</button>
      </div>

      <div id="playerCard" class="card-player">
        <img id="playerPhoto" src="" alt="Foto Pemain" />
        <p><strong>Name:</strong> <span id="playerName">-</span></p>
        <p><strong>Grade:</strong> <span id="playerClass">-</span></p>
        <p><strong>Total Score:</strong> <span id="playerTotal">-</span></p>
        <p><strong>Badge:</strong> <span id="playerBadges">-</span></p>
      </div>

      <div id="msg" class="message"></div>

      <div id="refresh-timer" style="margin: 10px 0; font-weight: bold">
        🔄 Next update in <span id="countdown">60</span> seconds...
      </div>

      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Name</th>
            <th>Grade</th>
            <th>UNO</th>
            <th>Chess</th>
            <th>Jenga</th>
            <th>Gaple</th>
            <th>Tepok Nyamuk</th>
            <th>Total Score</th>
            <th>Badge</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body"></tbody>
      </table>
    </div>

    <script>
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwN7tLWg7cSqJeScydRjpJnyROGm_XLaueVQEkhwfTDwXdG06eYD4pSmtWxXBbaIJKA/exec";
      let allPlayers = [];

      window.addEventListener("DOMContentLoaded", () => {
        fetchLeaderboard();
      });

      function fetchLeaderboard() {
        const msg = document.getElementById("msg");
        msg.textContent = "⏳ Loading leaderboard...";
        msg.style.color = "white";

        fetch(`${SCRIPT_URL}?all=1`)
          .then((res) => res.json())
          .then((data) => {
            allPlayers = data.sort(
              (a, b) => (b.total_score || 0) - (a.total_score || 0)
            );
            renderTable(allPlayers);
            msg.textContent = "";
          })
          .catch(() => {
            msg.textContent = "⚠️ Failed to load leaderboard";
            msg.style.color = "red";
          });
      }

      // Badge dengan icon
      function getBadges(player) {
        const badgeIcons = {
          // UNO
          "Quick Draw": "assets/badge/uno1.png",
          "Card Master": "assets/badge/uno2.png",
          "Deck Dominator": "assets/badge/uno3.png",
          "UNO Legend": "assets/badge/uno4.png",
          "Ultimate Trickster": "assets/badge/uno5.png",
          "Grandmaster of UNO": "assets/badge/uno6.png",

          // Chess
          "Pawn Starter": "assets/badge/chess1.png",
          "Knight Tactician": "assets/badge/chess2.png",
          "Rook Strategist": "assets/badge/chess3.png",
          "Queen's Gambit": "assets/badge/chess4.png",
          "King Slayer": "assets/badge/chess5.png",
          "Chess Grandmaster": "assets/badge/chess6.png",

          // Jenga
          "Steady Hands": "assets/badge/jenga1.png",
          "Block Builder": "assets/badge/jenga2.png",
          "Tower Architect": "assets/badge/jenga3.png",
          "Balance Master": "assets/badge/jenga4.png",
          "Stacking Genius": "assets/badge/jenga5.png",
          "Jenga Legend": "assets/badge/jenga6.png",

          // Mosquito Slap
          "Quick Reflex": "assets/badge/mosquito1.png",
          "Mosquito Hunter": "assets/badge/mosquito2.png",
          "Slap Expert": "assets/badge/mosquito3.png",
          "Insect Terminator": "assets/badge/mosquito4.png",
          "Bug Obliterator": "assets/badge/mosquito5.png",
          "Mosquito Slayer": "assets/badge/mosquito6.png",

          // Gaple (Domino)
          "Tile Rookie": "assets/badge/gaple1.png",
          "Pattern Player": "assets/badge/gaple2.png",
          "Double Master": "assets/badge/gaple3.png",
          "Chain Strategist": "assets/badge/gaple4.png",
          "Domino Emperor": "assets/badge/gaple5.png",
          "Gaple Grandmaster": "assets/badge/gaple6.png",
        };

        let badges = [];

        // 🔹 UNO
        if (player.uno >= 100) badges.push("Grandmaster of UNO");
        else if (player.uno >= 75) badges.push("Ultimate Trickster");
        else if (player.uno >= 55) badges.push("UNO Legend");
        else if (player.uno >= 35) badges.push("Deck Dominator");
        else if (player.uno >= 20) badges.push("Card Master");
        else if (player.uno >= 10) badges.push("Quick Draw");

        // 🔹 Chess
        if (player.catur >= 100) badges.push("Chess Grandmaster");
        else if (player.catur >= 75) badges.push("King Slayer");
        else if (player.catur >= 55) badges.push("Queen's Gambit");
        else if (player.catur >= 35) badges.push("Rook Strategist");
        else if (player.catur >= 20) badges.push("Knight Tactician");
        else if (player.catur >= 10) badges.push("Pawn Starter");

        // 🔹 Jenga
        if (player.jenga >= 100) badges.push("Jenga Legend");
        else if (player.jenga >= 75) badges.push("Stacking Genius");
        else if (player.jenga >= 55) badges.push("Balance Master");
        else if (player.jenga >= 35) badges.push("Tower Architect");
        else if (player.jenga >= 20) badges.push("Block Builder");
        else if (player.jenga >= 10) badges.push("Steady Hands");

        // 🔹 Mosquito Slap
        if (player.tepok_nyamuk >= 100) badges.push("Mosquito Slayer");
        else if (player.tepok_nyamuk >= 75) badges.push("Bug Obliterator");
        else if (player.tepok_nyamuk >= 55) badges.push("Insect Terminator");
        else if (player.tepok_nyamuk >= 35) badges.push("Slap Expert");
        else if (player.tepok_nyamuk >= 20) badges.push("Mosquito Hunter");
        else if (player.tepok_nyamuk >= 10) badges.push("Quick Reflex");

        // 🔹 Gaple (Domino)
        if (player.gaple >= 100) badges.push("Gaple Grandmaster");
        else if (player.gaple >= 75) badges.push("Domino Emperor");
        else if (player.gaple >= 55) badges.push("Chain Strategist");
        else if (player.gaple >= 35) badges.push("Double Master");
        else if (player.gaple >= 20) badges.push("Pattern Player");
        else if (player.gaple >= 10) badges.push("Tile Rookie");

        if (!badges.length) return "-";

        return badges
          .map(
            (b) =>
              `<img src="${badgeIcons[b]}" class="badge-icon" title="${b}"> ${b}`
          )
          .join("<br>");
      }

      function renderTable(players) {
        const tbody = document.getElementById("leaderboard-body");
        tbody.innerHTML = "";
        players.forEach((p, index) => {
          let trClass = "";
          if (index === 0) trClass = "top1";
          else if (index === 1) trClass = "top2";
          else if (index === 2) trClass = "top3";

          const tr = document.createElement("tr");
          tr.className = trClass;
          tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${p.nama || "-"}</td>
      <td>${p.kelas || "-"}</td>
      <td>${p.uno || 0}</td>
      <td>${p.catur || 0}</td>
      <td>${p.jenga || 0}</td>
      <td>${p.gaple || 0}</td>
      <td>${p.tepok_nyamuk || 0}</td>
      <td>${p.total_score || 0}</td>
      <td style="text-align: start;">${getBadges(p)}</td>
    `;
          tbody.appendChild(tr);
        });
      }

      function filterData() {
        const query = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        const playerCard = document.getElementById("playerCard");

        if (!query) {
          renderTable(allPlayers);
          playerCard.style.display = "none";
          return;
        }

        const filtered = allPlayers.filter((p) =>
          (p.nama || "").toLowerCase().includes(query)
        );
        renderTable(filtered);

        if (filtered.length > 0) {
          const p = filtered[0];
          document.getElementById("playerPhoto").src =
            p.foto || "assets/img/default.png";
          document.getElementById("playerName").textContent = p.nama || "-";
          document.getElementById("playerClass").textContent = p.kelas || "-";
          document.getElementById("playerTotal").textContent =
            p.total_score || "0";
          document.getElementById("playerBadges").innerHTML = getBadges(p);
          playerCard.style.display = "block";
        } else {
          playerCard.style.display = "none";
        }
      }
    </script>

    <script>
      function goToBadgeGallery() {
        window.location.href = "badgegalery.html"; // ganti dengan link halaman galeri badge
      }

      function adminPage() {
        window.location.href = "admin.html"; // ganti dengan link halaman admin
      }
    </script>

    <script>
      let countdown = 60; // detik
      const countdownEl = document.getElementById("countdown");

      function startAutoRefresh() {
        setInterval(() => {
          countdown--;
          countdownEl.textContent = countdown;

          if (countdown <= 0) {
            fetchLeaderboard(); // 🔁 panggil fungsi kamu yang sudah ada
            countdown = 60; // reset timer
          }
        }, 1000);
      }

      document.addEventListener("DOMContentLoaded", () => {
        startAutoRefresh();
      });
    </script>
  </body>
</html>
